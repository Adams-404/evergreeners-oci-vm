name: Create OCI VM

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-vm:
    runs-on: ubuntu-latest

    env:
      VM_NAME: evergreeners-backend
      AVAILABILITY_DOMAIN: AD-1
      SHAPE: VM.Standard.A1.Flex

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install OCI CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y curl python3 unzip
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Verify OCI CLI
        run: |
          which oci
          oci --version

      - name: Configure OCI CLI
        env:
          OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
          OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_PRIVATE_KEY: ${{ secrets.OCI_KEY_CONTENT }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
        run: |
          mkdir -p $HOME/.oci

          printf "[DEFAULT]\nuser=%s\nfingerprint=%s\nkey_file=%s\ntenancy=%s\nregion=%s\n" \
            "$OCI_USER_OCID" \
            "$OCI_FINGERPRINT" \
            "$HOME/.oci/oci_api_key.pem" \
            "$OCI_TENANCY_OCID" \
            "$OCI_REGION" > $HOME/.oci/config

          echo "$OCI_PRIVATE_KEY" | base64 --decode > $HOME/.oci/oci_api_key.pem
          chmod 600 $HOME/.oci/oci_api_key.pem

      - name: Create VM with retry loop
        env:
          OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
          OCI_REGION: ${{ secrets.OCI_REGION }}
          IMAGE_ID: ${{ secrets.OCI_IMAGE_ID }}
        run: |
          echo "Starting VM creation loop..."

          while true; do
            echo "Attempting to create VM..."

            OUTPUT=$(oci compute instance launch \
              --compartment-id "$OCI_COMPARTMENT_OCID" \
              --availability-domain "$AVAILABILITY_DOMAIN" \
              --shape "$SHAPE" \
              --display-name "$VM_NAME" \
              --image-id "$IMAGE_ID" \
              --assign-public-ip true \
              --wait-for-state RUNNING 2>&1)

            EXIT_CODE=$?

            if [ $EXIT_CODE -ne 0 ]; then
              echo "Creation failed. Retrying in 150 seconds..."
              echo "$OUTPUT"
              sleep 150
            else
              echo "VM successfully created."
              echo "$OUTPUT" > vm-info.json

              TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

              printf "# OCI VM Creation Report\n\nVM Name: %s\nShape: %s\nAvailability Domain: %s\nRegion: %s\nCreated At: %s\n\nRaw Response:\n\n\`\`\`\n%s\n\`\`\`\n" \
                "$VM_NAME" \
                "$SHAPE" \
                "$AVAILABILITY_DOMAIN" \
                "$OCI_REGION" \
                "$TIMESTAMP" \
                "$OUTPUT" > vm-report.md

              git config --global user.name "github-actions"
              git config --global user.email "github-actions@users.noreply.github.com"
              git add vm-info.json vm-report.md
              git commit -m "VM created at $TIMESTAMP"
              git push

              break
            fi
          done
