name: Create OCI VM

on:
  workflow_dispatch:   # allows manual triggering

jobs:
  create-vm:
    runs-on: ubuntu-latest
    env:
      PATH: $HOME/lib/oci-cli/bin:$PATH
      OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
      OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_PRIVATE_KEY: ${{ secrets.OCI_KEY_CONTENT }}
      OCI_REGION: ${{ secrets.OCI_REGION }}
      OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
      VM_NAME: evergreeners-backend
      AVAILABILITY_DOMAIN: AD-1
      SHAPE: VM.Standard.A1.Flex
      IMAGE: 'Canonical-Ubuntu-22.04-2026.01.29-0'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip python3-pip
          pip3 install --user oci

      - name: Install OCI CLI globally
        run: |
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash
          echo "export PATH=$HOME/lib/oci-cli/bin:$PATH" >> $GITHUB_ENV

      - name: Configure OCI CLI
        run: |
          mkdir -p $HOME/.oci
          echo "[DEFAULT]
user=${OCI_USER_OCID}
fingerprint=${OCI_FINGERPRINT}
key_file=$HOME/.oci/oci_api_key.pem
tenancy=${OCI_TENANCY_OCID}
region=${OCI_REGION}" > $HOME/.oci/config
          echo "${OCI_PRIVATE_KEY}" | base64 --decode > $HOME/.oci/oci_api_key.pem
          chmod 600 $HOME/.oci/oci_api_key.pem

      - name: Create VM loop
        run: |
          echo "Starting VM creation loop..."
          while true; do
            CREATE_OUTPUT=$(oci compute instance launch \
              --compartment-id $OCI_COMPARTMENT_OCID \
              --availability-domain $AVAILABILITY_DOMAIN \
              --shape $SHAPE \
              --display-name $VM_NAME \
              --image-id $IMAGE \
              --assign-public-ip true \
              --wait-for-state RUNNING 2>&1) || true

            if echo "$CREATE_OUTPUT" | grep -q "RESOURCE_NOT_FOUND\|ApiError\|Out of capacity"; then
              echo "VM not created yet. Retrying in 2m30s..."
              sleep 150
            else
              echo "VM created successfully!"
              echo "$CREATE_OUTPUT" > vm-info.txt
              git config --global user.name "github-actions"
              git config --global user.email "github-actions@users.noreply.github.com"
              git add vm-info.txt
              git commit -m "VM created at $(date -u)"
              git push
              break
            fi
          done
