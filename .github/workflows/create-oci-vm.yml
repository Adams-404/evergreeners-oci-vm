name: Create OCI VM

on:
  workflow_dispatch:

permissions:
  contents: write


jobs:
  create-vm:
    runs-on: ubuntu-latest

    env:
      OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
      OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_PRIVATE_KEY: ${{ secrets.OCI_KEY_CONTENT }}
      OCI_REGION: ${{ secrets.OCI_REGION }}
      OCI_COMPARTMENT_OCID: ${{ secrets.OCI_COMPARTMENT_OCID }}
      VM_NAME: evergreeners-backend
      AVAILABILITY_DOMAIN: AD-1
      SHAPE: VM.Standard.A1.Flex
      IMAGE_ID: ${{ secrets.OCI_IMAGE_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install OCI CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl python3
          curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | bash -s -- --accept-all-defaults
          echo "$HOME/lib/oci-cli/bin" >> $GITHUB_PATH

      - name: Configure OCI CLI
        run: |
          mkdir -p $HOME/.oci
          cat <<EOF > $HOME/.oci/config
          [DEFAULT]
          user=$OCI_USER_OCID
          fingerprint=$OCI_FINGERPRINT
          key_file=$HOME/.oci/oci_api_key.pem
          tenancy=$OCI_TENANCY_OCID
          region=$OCI_REGION
          EOF

          echo "$OCI_PRIVATE_KEY" | base64 --decode > $HOME/.oci/oci_api_key.pem
          chmod 600 $HOME/.oci/oci_api_key.pem

      - name: Create VM with retry loop
        run: |
          echo "Starting VM creation loop..."
          while true; do
            OUTPUT=$(oci compute instance launch \
              --compartment-id $OCI_COMPARTMENT_OCID \
              --availability-domain $AVAILABILITY_DOMAIN \
              --shape $SHAPE \
              --display-name $VM_NAME \
              --image-id $IMAGE_ID \
              --assign-public-ip true \
              --wait-for-state RUNNING 2>&1) || true

            if echo "$OUTPUT" | grep -qi "Out of capacity\|ApiError\|ServiceError"; then
              echo "Capacity not available. Retrying in 150 seconds..."
              sleep 150
            else
              echo "VM successfully created."
              echo "$OUTPUT" > vm-info.json

              TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

              cat <<EOF > vm-report.md
          # OCI VM Creation Report

          VM Name: $VM_NAME  
          Shape: $SHAPE  
          Availability Domain: $AVAILABILITY_DOMAIN  
          Region: $OCI_REGION  
          Created At: $TIMESTAMP  

          Raw Response:
          \`\`\`
          $OUTPUT
          \`\`\`
          EOF

              git config --global user.name "github-actions"
              git config --global user.email "github-actions@users.noreply.github.com"
              git add vm-info.json vm-report.md
              git commit -m "VM created at $TIMESTAMP"
              git push

              break
            fi
          done
